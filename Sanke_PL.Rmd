---
title: "Sanke_PL"
author: "Jeb"
date: "2024-04-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown


library(igraph)
library(networkD3)
plot_sankey <- function(df, from_to, count_fn = "n", fn_col = NULL, ...)
{
  count_fn <- match.arg(count_fn, c("n", "n_distinct", "sum"), several.ok = FALSE)
  from_to_ls <- lapply(1:(length(from_to)-1L), function(x) {
    setNames(from_to[x:(x+1L)], c("from", "to"))
  })
  the_dots <- list(...)
  dat_ls <- lapply(from_to_ls, function(x){
    dat <- df %>%  dplyr::mutate(dplyr::across(dplyr::all_of(unname(x)),
                                               function(y){
                                                 paste(dplyr::cur_column(), y, sep = ": ")
                                               })) %>% dplyr::rename(dplyr::all_of(x)) %>% dplyr::group_by(from, to)
    if (count_fn == "n"){
      dat <- dat %>% summarise(n = n(), .groups = "drop")
    }
    else {
      dat <- dat %>% dplyr::summarise(dplyr::across(dplyr::all_of(fn_col),
                                                    function(y) {
                                                      do.call(count_fn, append(list(y), the_dots))
                                                    }, .names = "n"), .groups = "drop")}
    dat})
  dat_ls <- dat_ls[sapply(dat_ls, inherits, "data.frame")]
  dat <- do.call(rbind, dat_ls)
  graph_from_df <- igraph::graph_from_data_frame(dat)
  g_d3 <- networkD3::igraph_to_networkD3(graph_from_df)
  networkD3::sankeyNetwork(Links = g_d3$links, Nodes = g_d3$nodes, Source = "source", Target = "target", Value = "value", NodeID = "name", fontSize = 11, margin = c(top = 100, bottom= 100), sinksRight = FALSE)
}
